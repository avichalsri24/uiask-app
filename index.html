<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UiAsk - Natural Language to SQL Query</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/default.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #2c3e50;
            line-height: 1.6;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .header p {
            color: #64748b;
            font-size: 1.1rem;
            font-weight: 400;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .query-section {
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .query-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            pointer-events: none;
        }

        .query-section label {
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.1rem;
            color: #ffffff;
            position: relative;
            z-index: 1;
        }

        .query-input {
            width: 100%;
            padding: 18px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.95);
            color: #2c3e50;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        .query-input:focus {
            outline: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            background: white;
            transform: translateY(-2px);
        }

        .query-input::placeholder {
            color: #94a3b8;
        }

        .source-selection {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
            justify-content: flex-end;
        }

        @media (max-width: 768px) {
            .source-selection {
                justify-content: center;
                gap: 10px;
            }
            
            .source-group {
                min-width: 110px;
            }
            
            .source-select {
                min-width: 110px;
                max-width: 130px;
                font-size: 12px;
            }
        }

        .source-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 120px;
        }

        .source-group label {
            font-size: 0.75rem;
            color: #ffffff;
            font-weight: 600;
            margin-bottom: 0;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            opacity: 0.85;
            padding-left: 2px;
        }

        .source-select {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.95);
            color: #374151;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
            cursor: pointer;
            min-width: 120px;
            max-width: 140px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 36px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23374151' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 32px;
        }

        .source-select:focus {
            outline: none;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            background: rgba(255, 255, 255, 0.98);
            transform: translateY(-1px);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .source-select:hover {
            background: rgba(255, 255, 255, 0.98);
            transform: translateY(-0.5px);
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.12);
        }

        .source-select option {
            padding: 6px 10px;
            color: #374151;
            font-weight: 500;
            font-size: 13px;
        }

        .source-select option[data-action="add"] {
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            color: #3b82f6;
            font-weight: 600;
            font-size: 12px;
        }

        .additional-source-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            background: rgba(255, 255, 255, 0.08);
            padding: 10px;
            border-radius: 8px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .remove-source-btn {
            padding: 6px 10px;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 4px;
            color: #ffffff;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            gap: 4px;
            height: 36px;
            white-space: nowrap;
        }

        .remove-source-btn:hover {
            background: rgba(239, 68, 68, 0.25);
            border-color: rgba(239, 68, 68, 0.5);
            transform: translateY(-0.5px);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.15);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .result-header h3 {
            color: #1e293b;
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0;
        }

        .duration-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        /* Enhanced markdown formatting styles */
        .result-heading {
            color: #1e293b;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
            line-height: 1.3;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }

        .result-heading:first-child {
            margin-top: 0;
        }

        .result-paragraph {
            color: #374151;
            line-height: 1.6;
            margin: 1rem 0;
            font-size: 1rem;
        }

        .result-list {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        .result-list li {
            color: #374151;
            line-height: 1.6;
            margin: 0.5rem 0;
            font-size: 1rem;
        }

        .inline-code {
            background: #f1f5f9;
            color: #e11d48;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            font-weight: 500;
        }

        .code-block {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin: 1.5rem 0;
            overflow-x: auto;
        }

        .code-block pre {
            margin: 0;
            padding: 1rem;
            background: none;
            border: none;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #1e293b;
        }

        .code-block code.sql {
            color: #059669;
            font-weight: 500;
        }

        .result-content {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            line-height: 1.7;
            color: #374151;
        }

        .result-content p {
            margin-bottom: 16px;
        }

        .result-content ol {
            margin: 16px 0;
            padding-left: 24px;
        }

        .result-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .result-content strong {
            color: #1f2937;
            font-weight: 600;
        }

        .result-content em {
            color: #6b7280;
            font-style: italic;
        }

        .sql-section {
            padding: 30px;
            background: #ffffff;
            border-top: 1px solid #e2e8f0;
        }

        .sql-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .sql-header h2 {
            font-size: 1.3rem;
            color: #1e293b;
            font-weight: 700;
        }





        .sql-editor-container {
            position: relative;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: #f8fafc;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .sql-editor {
            min-height: 250px;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .CodeMirror {
            height: 250px;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .CodeMirror-focused .CodeMirror-selected {
            background: #e6f3ff;
        }

        .sql-validation {
            padding: 12px 20px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            font-size: 13px;
            font-weight: 500;
        }

        .sql-validation.valid {
            color: #059669;
            background: #ecfdf5;
            border-top-color: #a7f3d0;
        }

        .sql-validation.invalid {
            color: #dc2626;
            background: #fef2f2;
            border-top-color: #fecaca;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .button-group {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(100, 116, 139, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn:disabled {
            background: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results-section {
            padding: 30px;
            background: #ffffff;
            border-top: 1px solid #e2e8f0;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .results-header h2 {
            font-size: 1.3rem;
            color: #1e293b;
            font-weight: 700;
        }

        .results-toolbar {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .format-selector {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .format-selector label {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 600;
            margin-right: 8px;
        }

        .format-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: white;
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .format-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            color: #475569;
        }

        .format-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .format-btn:first-of-type {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
        }

        .format-btn:not(:first-of-type):not(:last-of-type) {
            border-radius: 0;
            border-right: none;
        }

        .format-btn:last-of-type {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .copy-btn {
            padding: 8px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            color: #64748b;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .copy-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            color: #475569;
        }

        .copy-btn.copied {
            background: #dcfce7;
            border-color: #bbf7d0;
            color: #166534;
        }

        /* Structured Results Styles */
        .explanation-section,
        .sql-query-section,
        .execution-results-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .explanation-section:last-child,
        .sql-query-section:last-child,
        .execution-results-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-badge.success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #15803d;
            border: 1px solid #10b981;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .status-badge.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .data-table-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: auto;
            margin-top: 15px;
            max-height: 400px;
            max-width: 100%;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 600px;
        }

        .results-table th {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            color: white;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(2, 132, 199, 0.2);
        }

        .results-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            color: #374151;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
        }

        .results-table tr:last-child td {
            border-bottom: none;
        }

        .results-table tr:nth-child(even) {
            background: #f8fafc;
        }

        .results-table tr:hover {
            background: #f1f5f9;
        }

        .table-info {
            padding: 12px 16px;
            background: #f1f5f9;
            color: #64748b;
            font-size: 12px;
            font-weight: 500;
            border-top: 1px solid #e2e8f0;
            text-align: center;
        }



        .results-container {
            position: relative;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }



        .loading-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            color: #374151;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }

        .loading-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .loading-animation {
            position: relative;
            width: 120px;
            height: 120px;
            margin-bottom: 30px;
        }

        .loading-dots {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 8px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            animation: dotPulse 1.4s ease-in-out infinite both;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        .dot:nth-child(3) { animation-delay: 0s; }
        .dot:nth-child(4) { animation-delay: 0.16s; }

        @keyframes dotPulse {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .loading-rings {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .ring {
            position: absolute;
            border-radius: 50%;
            border-style: solid;
            animation: ringRotate 2s linear infinite;
        }

        .ring-1 {
            top: 10px;
            left: 10px;
            width: 100px;
            height: 100px;
            border-width: 2px;
            border-color: #3b82f6 transparent transparent transparent;
        }

        .ring-2 {
            top: 20px;
            left: 20px;
            width: 80px;
            height: 80px;
            border-width: 2px;
            border-color: transparent #10b981 transparent transparent;
            animation-duration: 1.5s;
            animation-direction: reverse;
        }

        .ring-3 {
            top: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            border-width: 2px;
            border-color: transparent transparent #f59e0b transparent;
            animation-duration: 1s;
        }

        @keyframes ringRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            text-align: center;
            z-index: 10;
        }

        .loading-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            animation: textGlow 2s ease-in-out infinite alternate;
        }

        .loading-subtitle {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
            animation: textFade 1.5s ease-in-out infinite;
            transition: opacity 0.3s ease-in-out;
        }

        @keyframes textGlow {
            0% { text-shadow: 0 0 5px rgba(59, 130, 246, 0.3); }
            100% { text-shadow: 0 0 10px rgba(59, 130, 246, 0.6); }
        }

        @keyframes textFade {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* SQL Editor Buffer Animation */
        .sql-editor-buffer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            z-index: 10;
            overflow: hidden;
        }

        .sql-buffer-lines {
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%;
        }

        .sql-buffer-line {
            height: 20px;
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            border-radius: 4px;
            animation: shimmer 2s infinite;
        }

        .sql-buffer-line-1 { width: 85%; animation-delay: 0s; }
        .sql-buffer-line-2 { width: 70%; animation-delay: 0.2s; }
        .sql-buffer-line-3 { width: 90%; animation-delay: 0.4s; }
        .sql-buffer-line-4 { width: 60%; animation-delay: 0.6s; }
        .sql-buffer-line-5 { width: 80%; animation-delay: 0.8s; }
        .sql-buffer-line-6 { width: 75%; animation-delay: 1s; }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .sql-buffer-overlay {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(59, 130, 246, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(10px);
        }

        .sql-buffer-text {
            color: #3b82f6;
            font-size: 0.9rem;
            font-weight: 500;
            animation: textPulse 1.5s ease-in-out infinite;
        }

        @keyframes textPulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* Results Buffer Animation */
        .results-buffer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            z-index: 10;
            overflow: hidden;
        }

        .results-buffer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .results-buffer-title {
            width: 200px;
            height: 24px;
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            border-radius: 6px;
            animation: shimmer 2s infinite;
        }

        .results-buffer-badge {
            width: 120px;
            height: 28px;
            background: linear-gradient(90deg, #dcfce7 25%, #f0fdf4 50%, #dcfce7 75%);
            background-size: 200% 100%;
            border-radius: 20px;
            animation: shimmer 2s infinite 0.3s;
        }

        .results-buffer-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .results-buffer-line {
            height: 18px;
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            border-radius: 4px;
            animation: shimmer 2s infinite;
        }

        .results-buffer-line-long { 
            width: 95%; 
            animation-delay: 0s; 
        }

        .results-buffer-line-medium { 
            width: 75%; 
            animation-delay: 0.2s; 
        }

        .results-buffer-line-short { 
            width: 60%; 
            animation-delay: 0.4s; 
        }

        .results-buffer-overlay {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(16, 185, 129, 0.3);
            backdrop-filter: blur(10px);
        }

        .results-buffer-text {
            color: #10b981;
            font-size: 0.9rem;
            font-weight: 500;
            animation: textPulse 1.5s ease-in-out infinite;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #fecaca;
            font-weight: 500;
        }

        .success-message {
            background: #ecfdf5;
            color: #059669;
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #a7f3d0;
            font-weight: 500;
        }

        .no-results {
            text-align: center;
            padding: 80px 20px;
            color: #64748b;
        }

        .no-results-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.4;
        }

        .no-results h3 {
            color: #374151;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .no-results p {
            color: #64748b;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .button-group {
                width: 100%;
                justify-content: center;
            }
            
            .results-toolbar {
                flex-wrap: wrap;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>C360 AI <span class="rocket-emoji">🚀</span></h1>
            <p>Customer 360 data using Natural Language on your fingertips</p>
        </div>

        <div class="main-content">
            <div class="query-section">
                <label for="naturalQuery">Write your Natural Language Query</label>
                
                <div class="source-selection">
                    
                    <div class="source-group">
                        <label for="ontologySelect">Ontology</label>
                        <select id="ontologySelect" class="source-select">
                            <option value="">Select...</option>
                            <option value="github_ontology">GitHub</option>
                            <option value="jira_ontology">Jira</option>
                            <option value="upload_ontology" data-action="add">📁 Upload</option>
                        </select>
                    </div>
                </div>
                
                <input type="text" id="naturalQuery" class="query-input" placeholder="e.g., Show me total additions and deletions by department">
                <div class="action-buttons">
                    <div class="button-group">
                        <button id="generateSql" class="btn btn-primary">Generate Results</button>
                    </div>
                </div>
            </div>

            <div class="sql-section">
                <div class="sql-header">
                    <h2>SQL Query Editor</h2>
                </div>
                
                <div class="sql-editor-container">
                    <div id="sqlEditorBuffer" class="sql-editor-buffer" style="display: none;">
                        <div class="sql-buffer-lines">
                            <div class="sql-buffer-line sql-buffer-line-1"></div>
                            <div class="sql-buffer-line sql-buffer-line-2"></div>
                            <div class="sql-buffer-line sql-buffer-line-3"></div>
                            <div class="sql-buffer-line sql-buffer-line-4"></div>
                            <div class="sql-buffer-line sql-buffer-line-5"></div>
                            <div class="sql-buffer-line sql-buffer-line-6"></div>
                        </div>
                        <div class="sql-buffer-overlay">
                            <div class="sql-buffer-text">Generating SQL...</div>
                        </div>
                    </div>
                    <div id="sqlEditor" class="sql-editor"></div>
                    <div id="sqlValidation" class="sql-validation">
                        <span id="validationMessage">Ready to write SQL...</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <div class="button-group">
                        <button id="formatSql" class="btn btn-secondary">Format SQL</button>
                        <button id="clearSql" class="btn btn-secondary">Clear</button>
                    </div>
                    <div class="button-group">
                        <button id="runQuery" class="btn btn-success">RUN</button>
                    </div>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <h2>Results</h2>
                </div>
                
                <div id="resultsContainer" class="results-container">
                    <div class="loading-container" style="display: none;" id="loadingIndicator">
                        <div class="loading-animation">
                            <div class="loading-dots">
                                <div class="dot"></div>
                                <div class="dot"></div>
                                <div class="dot"></div>
                                <div class="dot"></div>
                            </div>
                            <div class="loading-rings">
                                <div class="ring ring-1"></div>
                                <div class="ring ring-2"></div>
                                <div class="ring ring-3"></div>
                            </div>
                        </div>
                        <div class="loading-text">
                            <div class="loading-title">Processing your query...</div>
                            <div class="loading-subtitle" id="loadingSubtitle">Initializing agent</div>
                        </div>
                    </div>
                    <div id="errorMessage" class="error-message" style="display: none;"></div>
                    <div id="resultsBuffer" class="results-buffer" style="display: none;">
                        <div class="results-buffer-header">
                            <div class="results-buffer-title"></div>
                            <div class="results-buffer-badge"></div>
                        </div>
                        <div class="results-buffer-content">
                            <div class="results-buffer-line results-buffer-line-long"></div>
                            <div class="results-buffer-line results-buffer-line-medium"></div>
                            <div class="results-buffer-line results-buffer-line-short"></div>
                            <div class="results-buffer-line results-buffer-line-long"></div>
                            <div class="results-buffer-line results-buffer-line-medium"></div>
                            <div class="results-buffer-line results-buffer-line-short"></div>
                            <div class="results-buffer-line results-buffer-line-long"></div>
                        </div>
                        <div class="results-buffer-overlay">
                            <div class="results-buffer-text">Processing results...</div>
                        </div>
                    </div>
                    <div id="resultsContent">
                        <div class="no-results">
                            <div class="no-results-icon">🔍</div>
                            <h3>No results to display</h3>
                            <p>Run a query to see results here</p>
                        </div>
                    </div>
                </div>
                

            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/sql-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>

    <script>
        // Configuration for API endpoints
        const API_CONFIG = {
            generateSqlEndpoint: '/api/generate-sql',
            executeQueryEndpoint: '/api/execute-query',
            configEndpoint: '/api/config'
        };

        // Global variables
        let sqlEditor;
        let appConfig = null;


        // DOM Elements
        const naturalQueryInput = document.getElementById('naturalQuery');
        const generateSqlBtn = document.getElementById('generateSql');
        const runQueryBtn = document.getElementById('runQuery');
        const formatSqlBtn = document.getElementById('formatSql');
        const clearSqlBtn = document.getElementById('clearSql');

        const resultsContainer = document.getElementById('resultsContainer');
        const resultsContent = document.getElementById('resultsContent');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');

        const validationMessage = document.getElementById('validationMessage');

        // Dummy data for development
        const DUMMY_DATA = {
            sqlGeneration: {
                'Show me total additions and deletions by department': `SELECT och.Department, SUM(pr.additions) AS total_additions, SUM(pr.deletions) AS total_deletions FROM 
sadasd.CloudToolsDataDev.dbo.PullRequests pr JOIN sadasd.CloudToolsDataDev.dbo.GitHubUsers gu ON pr.authorName = gu.Login JOIN 
sadasd.CloudToolsDataDev.dbo.OrganizationChartHistory och ON gu.SamNameId = och.WorkEmail WHERE pr.isDraft = FALSE AND pr.merged_at >= 
DATE_TRUNC('year', CURRENT_DATE) GROUP BY och.Department LIMIT 100;`,
                'default': `SELECT och.Department, SUM(pr.additions) AS total_additions, SUM(pr.deletions) AS total_deletions FROM 
sadasd.CloudToolsDataDev.dbo.PullRequests pr JOIN sadasd.CloudToolsDataDev.dbo.GitHubUsers gu ON pr.authorName = gu.Login JOIN 
sadasd.CloudToolsDataDev.dbo.OrganizationChartHistory och ON gu.SamNameId = och.WorkEmail WHERE pr.isDraft = FALSE AND pr.merged_at >= 
DATE_TRUNC('year', CURRENT_DATE) GROUP BY och.Department LIMIT 100;`
            },
            queryResults: {
                columns: ['Department', 'total_additions', 'total_deletions'],
                rows: [
                    ['Engineering', '7306571482', '3852564261'],
                    ['Product', '221112604', '51776800'],
                    ['Services', '120655', '36004'],
                    ['Product Support', '344918', '5537'],
                    ['Marketing', '51208', '17127'],
                    ['Sales Support', '386906', '0'],
                    ['Delivery', '285', '37']
                ]
            }
        };

        // Initialize CodeMirror SQL Editor
        function initializeSqlEditor() {
            sqlEditor = CodeMirror(document.getElementById('sqlEditor'), {
                mode: 'sql',
                theme: 'default',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentWithTabs: true,
                smartIndent: true,
                lineWrapping: true,
                extraKeys: {
                    'Ctrl-Space': 'autocomplete',
                    'Ctrl-Enter': executeQuery,
                    'Cmd-Enter': executeQuery,
                    'F11': function(cm) {
                        cm.setOption('fullScreen', !cm.getOption('fullScreen'));
                    },
                    'Esc': function(cm) {
                        if (cm.getOption('fullScreen')) cm.setOption('fullScreen', false);
                    }
                },
                hintOptions: {
                    tables: {
                        'PullRequests': ['authorName', 'additions', 'deletions', 'isDraft', 'merged_at'],
                        'GitHubUsers': ['Login', 'SamNameId'],
                        'OrganizationChartHistory': ['Department', 'WorkEmail']
                    }
                }
            });

            // SQL validation on change
            sqlEditor.on('change', function() {
                validateSql();
            });

            // Set placeholder text
            sqlEditor.setValue('-- Generated SQL query will appear here...\n');
        }

        // Event Listeners
        generateSqlBtn.addEventListener('click', generateSqlQuery);
        runQueryBtn.addEventListener('click', executeQuery);
        formatSqlBtn.addEventListener('click', formatSqlQuery);
        clearSqlBtn.addEventListener('click', clearSqlQuery);

        
        naturalQueryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                generateSqlQuery();
            }
        });





        // SQL Validation
        function validateSql() {
            const sqlQuery = sqlEditor.getValue().trim();
            
            if (!sqlQuery || sqlQuery.startsWith('--')) {
                validationMessage.textContent = 'Ready to write SQL...';
                validationMessage.className = 'sql-validation';
                return;
            }
            
            // Basic SQL validation
            const keywords = ['SELECT', 'FROM', 'WHERE', 'JOIN', 'GROUP BY', 'ORDER BY', 'LIMIT'];
            const hasSelect = /^\s*SELECT\s+/i.test(sqlQuery);
            const hasFrom = /\s+FROM\s+/i.test(sqlQuery);
            const hasSemicolon = sqlQuery.trim().endsWith(';');
            
            if (!hasSelect) {
                validationMessage.textContent = '⚠️ SQL should start with SELECT';
                validationMessage.className = 'sql-validation invalid';
                return;
            }
            
            if (!hasFrom) {
                validationMessage.textContent = '⚠️ SQL should include FROM clause';
                validationMessage.className = 'sql-validation invalid';
                return;
            }
            
            if (!hasSemicolon) {
                validationMessage.textContent = '⚠️ SQL should end with semicolon (;)';
                validationMessage.className = 'sql-validation invalid';
                return;
            }
            
            validationMessage.textContent = '✅ SQL syntax looks good';
            validationMessage.className = 'sql-validation valid';
        }

        // Format SQL Query
        function formatSqlQuery() {
            const sqlQuery = sqlEditor.getValue();
            if (!sqlQuery.trim()) return;
            
            // Basic SQL formatting
            const formatted = sqlQuery
                .replace(/\s+/g, ' ')
                .replace(/\s*,\s*/g, ', ')
                .replace(/\s*\(\s*/g, '(')
                .replace(/\s*\)\s*/g, ')')
                .replace(/\bSELECT\b/gi, 'SELECT')
                .replace(/\bFROM\b/gi, 'FROM')
                .replace(/\bWHERE\b/gi, 'WHERE')
                .replace(/\bJOIN\b/gi, 'JOIN')
                .replace(/\bINNER JOIN\b/gi, 'INNER JOIN')
                .replace(/\bLEFT JOIN\b/gi, 'LEFT JOIN')
                .replace(/\bRIGHT JOIN\b/gi, 'RIGHT JOIN')
                .replace(/\bGROUP BY\b/gi, 'GROUP BY')
                .replace(/\bORDER BY\b/gi, 'ORDER BY')
                .replace(/\bLIMIT\b/gi, 'LIMIT')
                .replace(/\bAND\b/gi, 'AND')
                .replace(/\bOR\b/gi, 'OR')
                .trim();
            
            sqlEditor.setValue(ensureSqlEndsWithSemicolon(formatted));
        }

        // Clear SQL Query
        function clearSqlQuery() {
            sqlEditor.setValue('-- Generated SQL query will appear here...');
        }



        // Generate SQL Query
        async function generateSqlQuery() {
            const naturalQuery = naturalQueryInput.value.trim();
            
            if (!naturalQuery) {
                showError('Please enter a natural language query');
                return;
            }

            generateSqlBtn.disabled = true;
            generateSqlBtn.textContent = 'Generating...';
            
            // Show SQL buffer animation
            showSqlBuffer();
            updateSqlBufferText('Generating SQL query...');

            try {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));

                // In production, replace this with actual API call
                const sqlQuery = await callGenerateSqlAPI(naturalQuery);
                
                updateSqlBufferText('Finalizing query...');
                await new Promise(resolve => setTimeout(resolve, 500)); // Brief delay for final message
                
                sqlEditor.setValue(ensureSqlEndsWithSemicolon(sqlQuery));
                hideError();
                
            } catch (error) {
                showError('Failed to generate SQL query: ' + error.message);
                hideResultsBuffer(); // Also hide results buffer on error
            } finally {
                hideSqlBuffer();
                generateSqlBtn.disabled = false;
                generateSqlBtn.textContent = 'Generate SQL';
            }
        }

        // Execute Query
        async function executeQuery() {
            const sqlQuery = sqlEditor.getValue().trim();
            
            if (!sqlQuery || sqlQuery.startsWith('--')) {
                showError('Please enter or generate a SQL query');
                return;
            }

            const startTime = Date.now();
            showLoading();
            runQueryBtn.disabled = true;
            runQueryBtn.textContent = 'Running...';

            try {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1500));

                // In production, replace this with actual API call
                const results = await callExecuteQueryAPI(sqlQuery);
                
                const duration = Date.now() - startTime;
                results.duration = duration;
                
                // Note: Query execution results are handled separately from agent response content
                // The agent response content is displayed in markdown format via the other displayResults function
                
                hideError();
                
            } catch (error) {
                showError('Failed to execute query: ' + error.message);
                hideLoading();
            } finally {
                runQueryBtn.disabled = false;
                runQueryBtn.textContent = 'RUN';
            }
        }

        // API Calls
        async function callGenerateSqlAPI(naturalQuery) {
            try {
                // Show results buffer animation
                showResultsBuffer();
                updateResultsBufferText('Starting orchestrator job...');
                
                // Load configuration from server
                if (!appConfig) {
                    throw new Error('Configuration not loaded. Please refresh the page.');
                }
                
                // Start orchestrator job
                const startResponse = await fetch('/api/start-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: naturalQuery,
                        current_date: new Date().toISOString().split('T')[0]
                    })
                });

                if (!startResponse.ok) {
                    const errorData = await startResponse.json();
                    throw new Error(errorData.error || `HTTP error! status: ${startResponse.status}`);
                }

                const startData = await startResponse.json();
                console.log('Job started:', startData);
                
                if (startData.job_key) {
                    showNotification(`✅ Job started! Key: ${startData.job_key}`, 'success');
                    setLoadingMessage('Job started, initializing polling...');
                    updateResultsBufferText('Job started, initializing polling...');
                    
                    // Store the job key for later use
                    window.currentJobKey = startData.job_key;
                    localStorage.setItem('currentJobKey', startData.job_key);
                    
                    // Small delay to ensure UI updates are visible
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Start polling for results
                    const result = await pollJobResponse(startData.job_key);
                    return result;
                }
                
                throw new Error('No job key received from API');
                
            } catch (error) {
                console.error('Error starting job:', error);
                hideResultsBuffer();
                throw new Error(`Failed to start job: ${error.message}`);
            }
        }

        // Poll job response and retrieve results with visual timer
        async function pollJobResponse(jobKey) {
            const maxAttempts = 60; // 2 minute with 2-second intervals
            let actualAttempts = 0;
            let visualAttempts = 0;
            const startTime = Date.now();
            let isComplete = false;
            
            // Start visual timer that updates UI every 2 seconds
            const visualTimer = setInterval(() => {
                if (isComplete) {
                    clearInterval(visualTimer);
                    return;
                }
                
                visualAttempts = Math.min(visualAttempts + 1, maxAttempts);
                console.log('📊 Visual progress update:', progressMessage);
                updateResultsBufferText(progressMessage);
                setLoadingMessage(progressMessage);
                
                // Force immediate DOM update
                document.body.offsetHeight;
            }, 2000);
            
            // Start actual API polling
            while (actualAttempts < maxAttempts && !isComplete) {
                try {
                    actualAttempts++;
                    console.log(`API polling attempt ${actualAttempts}/${maxAttempts}...`);
                    
                    const response = await fetch(`/api/job-response/${jobKey}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const responseData = await response.json();
                    console.log('Job response:', responseData);
                    
                    if (responseData.status === 'completed' && responseData.response) {
                        console.log('Job completed successfully!');
                        isComplete = true;
                        clearInterval(visualTimer);
                        
                        setLoadingMessage('Processing completed results...');
                        updateResultsBufferText('Job completed! Processing results...');
                        
                        const duration = Date.now() - startTime;
                        
                        // The orchestrator returns structured response with generatedSQLQuery, queryExplanation, and queryExecutionResults
                        const llmResponse = responseData.response;
                        
                        showNotification('✅ Job completed successfully!', 'success');
                        setLoadingMessage('Formatting results...');
                        updateResultsBufferText('Formatting results...');
                        
                        // Display the response content
                        if (llmResponse) {
                            // Check if it's the new structured response format
                            if (typeof llmResponse === 'object' && llmResponse.generatedSQLQuery) {
                                // New structured format
                                displayStructuredResults(llmResponse, duration);
                                return ensureSqlEndsWithSemicolon(llmResponse.generatedSQLQuery);
                            } else if (typeof llmResponse === 'string') {
                                // Legacy string format - try to extract SQL
                                displayResults(llmResponse, duration);
                                
                                const sqlMatch = llmResponse.match(/```sql\n(.*?)\n```/s) || 
                                               llmResponse.match(/```\n(SELECT.*?;)\n```/s) ||
                                               llmResponse.match(/(SELECT.*?;)/s);
                                
                                if (sqlMatch && sqlMatch[1]) {
                                    return ensureSqlEndsWithSemicolon(sqlMatch[1].trim());
                                }
                            } else {
                                // Unknown format, display as is
                                displayResults(JSON.stringify(llmResponse, null, 2), duration);
                            }
                        }
                        
                        return '-- SQL query completed successfully\n-- Check results section for detailed response';
                        
                    } else if (responseData.status === 'pending') {
                        // Still running, wait 2 seconds before next API poll
                        if (actualAttempts < maxAttempts) {
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    } else {
                        isComplete = true;
                        clearInterval(visualTimer);
                        hideResultsBuffer();
                        throw new Error(`Job failed with status: ${responseData.status}`);
                    }
                    
                } catch (error) {
                    isComplete = true;
                    clearInterval(visualTimer);
                    console.error('Error polling job response:', error);
                    throw error;
                }
            }
            
            // Timeout reached
            isComplete = true;
            clearInterval(visualTimer);
            hideResultsBuffer();
            throw new Error('Timeout: Job did not complete within 1 minute');
        }

        // Helper function to ensure SQL query ends with semicolon
        function ensureSqlEndsWithSemicolon(sqlQuery) {
            if (!sqlQuery || typeof sqlQuery !== 'string') {
                return sqlQuery;
            }
            
            // Trim whitespace and check if it ends with semicolon
            const trimmed = sqlQuery.trim();
            if (trimmed && !trimmed.endsWith(';')) {
                return trimmed + ';';
            }
            return sqlQuery;
        }

        // Display structured results from the new orchestrator response format
        function displayStructuredResults(response, duration) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsContent = document.getElementById('resultsContent');
            
            if (resultsContainer && resultsContent) {
                // Hide results buffer animation
                updateResultsBufferText('Finalizing display...');
                
                // Small delay to show final message
                setTimeout(() => {
                    let formattedContent = '';
                    
                    // Add query explanation section
                    if (response.queryExplanation) {
                        formattedContent += `
                            <div class="explanation-section">
                                <h3 class="result-heading">Query Explanation</h3>
                                <div class="result-paragraph">${response.queryExplanation}</div>
                            </div>
                        `;
                    }
                    
                    // Add execution results section with enhanced formatting (SQL query removed since it's shown above)
                    if (response.queryExecutionResults) {
                        formattedContent += formatExecutionResultsEnhanced(response.queryExecutionResults);
                    }
                    
                    resultsContent.innerHTML = `
                        <div class="result-header">
                            <h3>Query Results</h3>
                            <span class="duration-badge">Completed in ${(duration / 1000).toFixed(2)}s</span>
                        </div>
                        <div class="result-content">
                            ${formattedContent}
                        </div>
                    `;
                    
                    // Add event listeners for format selector and copy button
                    setupResultsInteractivity(response.queryExecutionResults);
                    
                    resultsContainer.style.display = 'block';
                    hideResultsBuffer();
                }, 300);
            }
        }

        // Enhanced format execution results with format selector and copy functionality
        function formatExecutionResultsEnhanced(results) {
            if (!results) return '';
            
            const statusBadge = results.status ? 
                `<span class="status-badge ${results.status === 'success' ? 'success' : 'error'}">${results.status === 'success' ? 'COMPLETED' : results.status.toUpperCase()}</span>` : '';
            
            let html = `
                <div class="execution-results-section">
                    <div class="results-header">
                        <h3 class="result-heading">Execution Results${statusBadge}</h3>
                        <div class="results-toolbar">
                            <div class="format-selector">
                                <label>Format:</label>
                                <button class="format-btn active" data-format="table" onclick="changeDataFormat('table')">Table</button>
                                <button class="format-btn" data-format="json" onclick="changeDataFormat('json')">JSON</button>
                                <button class="format-btn" data-format="csv" onclick="changeDataFormat('csv')">CSV</button>
                            </div>
                            <button class="copy-btn" onclick="copyDataToClipboard()">
                                <span>📋</span> Copy
                            </button>
                        </div>
                    </div>
            `;
            
            if (results.data && Array.isArray(results.data) && results.data.length > 0) {
                html += `<div id="dataDisplay">${formatAsTable(results.data)}</div>`;
                html += `<div class="table-info">${results.data.length} row(s) returned</div>`;
            } else if (results.message) {
                html += `<div class="result-paragraph">${results.message}</div>`;
            } else {
                html += `<div class="result-paragraph">No data returned</div>`;
            }
            
            html += '</div>';
            return html;
        }

        // Format data as table
        function formatAsTable(data) {
            if (!data || !Array.isArray(data) || data.length === 0) return '';
            
            let html = `
                <div class="data-table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
            `;
            
            // Generate table headers from first row keys
            const firstRow = data[0];
            Object.keys(firstRow).forEach(key => {
                html += `<th>${key}</th>`;
            });
            
            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Generate table rows
            data.forEach(row => {
                html += '<tr>';
                Object.values(row).forEach(value => {
                    html += `<td>${value || ''}</td>`;
                });
                html += '</tr>';
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        // Format data as JSON
        function formatAsJSON(data) {
            return `
                <div class="code-block">
                    <pre><code>${JSON.stringify(data, null, 2)}</code></pre>
                </div>
            `;
        }

        // Format data as CSV
        function formatAsCSV(data) {
            if (!data || !Array.isArray(data) || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            let csvContent = headers.join(',') + '\n';
            
            data.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header] || '';
                    // Escape commas and quotes in CSV
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csvContent += values.join(',') + '\n';
            });
            
            return `
                <div class="code-block">
                    <pre><code>${csvContent}</code></pre>
                </div>
            `;
        }

        // Setup interactivity for results
        function setupResultsInteractivity(data) {
            window.currentResultsData = data;
        }

        // Change data format
        function changeDataFormat(format) {
            const dataDisplay = document.getElementById('dataDisplay');
            const data = window.currentResultsData?.data;
            
            if (!dataDisplay || !data) return;
            
            // Update active button
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-format') === format) {
                    btn.classList.add('active');
                }
            });
            
            // Update display based on format
            switch (format) {
                case 'table':
                    dataDisplay.innerHTML = formatAsTable(data);
                    break;
                case 'json':
                    dataDisplay.innerHTML = formatAsJSON(data);
                    break;
                case 'csv':
                    dataDisplay.innerHTML = formatAsCSV(data);
                    break;
            }
        }

        // Copy data to clipboard
        function copyDataToClipboard() {
            const copyBtn = document.querySelector('.copy-btn');
            const data = window.currentResultsData?.data;
            const activeFormatBtn = document.querySelector('.format-btn.active');
            
            if (!data || !copyBtn || !activeFormatBtn) return;
            
            const format = activeFormatBtn.getAttribute('data-format');
            let textToCopy = '';
            
            switch (format) {
                case 'table':
                    // For table, copy as tab-separated values
                    const headers = Object.keys(data[0]);
                    textToCopy = headers.join('\t') + '\n';
                    data.forEach(row => {
                        const values = headers.map(header => row[header] || '');
                        textToCopy += values.join('\t') + '\n';
                    });
                    break;
                case 'json':
                    textToCopy = JSON.stringify(data, null, 2);
                    break;
                case 'csv':
                    const csvHeaders = Object.keys(data[0]);
                    textToCopy = csvHeaders.join(',') + '\n';
                    data.forEach(row => {
                        const values = csvHeaders.map(header => {
                            let value = row[header] || '';
                            if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                                value = '"' + value.replace(/"/g, '""') + '"';
                            }
                            return value;
                        });
                        textToCopy += values.join(',') + '\n';
                    });
                    break;
            }
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                // Visual feedback
                copyBtn.classList.add('copied');
                copyBtn.innerHTML = '<span>✅</span> Copied!';
                
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    copyBtn.innerHTML = '<span>📋</span> Copy';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy to clipboard', 'error');
            });
        }

        // Format execution results into HTML (legacy format)
        function formatExecutionResults(results) {
            if (!results) return '';
            
            let html = `
                <div class="execution-results-section">
                    <h3 class="result-heading">Execution Results</h3>
            `;
            
            if (results.status) {
                const statusClass = results.status === 'success' ? 'success' : 'error';
                html += `<div class="status-badge ${statusClass}">Status: ${results.status}</div>`;
            }
            
            if (results.data && Array.isArray(results.data)) {
                html += `
                    <div class="data-table-container">
                        <table class="results-table">
                            <thead>
                                <tr>
                `;
                
                // Generate table headers from first row keys
                if (results.data.length > 0) {
                    const firstRow = results.data[0];
                    Object.keys(firstRow).forEach(key => {
                        html += `<th>${key}</th>`;
                    });
                }
                
                html += `
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Generate table rows
                results.data.forEach(row => {
                    html += '<tr>';
                    Object.values(row).forEach(value => {
                        html += `<td>${value || ''}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += `
                            </tbody>
                        </table>
                        <div class="table-info">
                            ${results.data.length} row(s) returned
                        </div>
                    </div>
                `;
            } else if (results.message) {
                html += `<div class="result-paragraph">${results.message}</div>`;
            }
            
            html += '</div>';
            return html;
        }

        // Display results in markdown format (legacy format)
        function displayResults(content, duration) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsContent = document.getElementById('resultsContent');
            
            if (resultsContainer && resultsContent) {
                // Hide results buffer animation
                updateResultsBufferText('Finalizing display...');
                
                // Small delay to show final message
                setTimeout(() => {
                    // Convert content to markdown-style HTML
                    const formattedContent = formatContentAsMarkdown(content);
                    
                    resultsContent.innerHTML = `
                        <div class="result-header">
                            <h3>Query Results</h3>
                            <span class="duration-badge">Completed in ${(duration / 1000).toFixed(2)}s</span>
                        </div>
                        <div class="result-content">
                            ${formattedContent}
                        </div>
                    `;
                    
                    resultsContainer.style.display = 'block';
                    hideResultsBuffer();
                }, 300);
            }
        }

        // Format content as markdown-style HTML for natural language display
        function formatContentAsMarkdown(content) {
            if (!content) return '';
            
            // Convert content to more natural markdown formatting
            let formatted = content
                // Handle headers
                .replace(/^### (.*$)/gm, '<h3 class="result-heading">$1</h3>')
                .replace(/^## (.*$)/gm, '<h2 class="result-heading">$1</h2>')
                .replace(/^# (.*$)/gm, '<h1 class="result-heading">$1</h1>')
                // Handle bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Handle italic text
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Handle inline code
                .replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>')
                // Handle code blocks
                .replace(/```sql\n([\s\S]*?)```/g, '<div class="code-block"><pre><code class="sql">$1</code></pre></div>')
                .replace(/```([\s\S]*?)```/g, '<div class="code-block"><pre><code>$1</code></pre></div>');
            
            // Process lines for better formatting
            const lines = formatted.split('\n');
            let inOrderedList = false;
            let inUnorderedList = false;
            let result = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Handle ordered lists (1. 2. 3.)
                const orderedListMatch = line.match(/^(\d+)\.\s(.+)$/);
                // Handle unordered lists (- or *)
                const unorderedListMatch = line.match(/^[-*]\s(.+)$/);
                
                if (orderedListMatch) {
                    if (!inOrderedList) {
                        if (inUnorderedList) {
                            result += '</ul>';
                            inUnorderedList = false;
                        }
                        result += '<ol class="result-list">';
                        inOrderedList = true;
                    }
                    result += `<li>${orderedListMatch[2]}</li>`;
                } else if (unorderedListMatch) {
                    if (!inUnorderedList) {
                        if (inOrderedList) {
                            result += '</ol>';
                            inOrderedList = false;
                        }
                        result += '<ul class="result-list">';
                        inUnorderedList = true;
                    }
                    result += `<li>${unorderedListMatch[1]}</li>`;
                } else {
                    // Close any open lists
                    if (inOrderedList) {
                        result += '</ol>';
                        inOrderedList = false;
                    }
                    if (inUnorderedList) {
                        result += '</ul>';
                        inUnorderedList = false;
                    }
                    
                    // Add paragraph if line has content
                    if (line) {
                        // Don't wrap if it's already a heading or code block
                        if (line.startsWith('<h') || line.startsWith('<div class="code-block"')) {
                            result += line;
                        } else {
                            result += `<p class="result-paragraph">${line}</p>`;
                        }
                    }
                }
            }
            
            // Close any remaining open lists
            if (inOrderedList) {
                result += '</ol>';
            }
            if (inUnorderedList) {
                result += '</ul>';
            }
            
            return result;
        }

        async function callExecuteQueryAPI(sqlQuery) {
            // TODO: Replace with actual API call
            // const response = await fetch(API_CONFIG.executeQueryEndpoint, {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json',
            //     },
            //     body: JSON.stringify({ sql: sqlQuery })
            // });
            // 
            // if (!response.ok) {
            //     throw new Error(`HTTP error! status: ${response.status}`);
            // }
            // 
            // const data = await response.json();
            // return data;

            // Using dummy data for now
            return DUMMY_DATA.queryResults;
        }



        // Utility Functions
        let loadingMessageIndex = 0;
        let loadingMessageInterval;
        const loadingMessages = [
            "Initializing agent...",
            "Processing your query...",
            "Analyzing data sources...",
            "Generating SQL query...",
            "Executing query...",
            "Formatting results...",
            "Almost ready..."
        ];

        function showLoading() {
            loadingIndicator.style.display = 'flex';
            resultsContent.style.display = 'none';
            
            // Reset and start loading message cycle
            loadingMessageIndex = 0;
            updateLoadingMessage();
            
            // Cycle through messages every 2 seconds
            loadingMessageInterval = setInterval(() => {
                loadingMessageIndex = (loadingMessageIndex + 1) % loadingMessages.length;
                updateLoadingMessage();
            }, 2000);
        }

        function hideLoading() {
            loadingIndicator.style.display = 'none';
            resultsContent.style.display = 'block';
            
            // Clear the loading message interval
            if (loadingMessageInterval) {
                clearInterval(loadingMessageInterval);
                loadingMessageInterval = null;
            }
        }

        function updateLoadingMessage() {
            const loadingSubtitle = document.getElementById('loadingSubtitle');
            if (loadingSubtitle) {
                loadingSubtitle.style.opacity = '0';
                setTimeout(() => {
                    loadingSubtitle.textContent = loadingMessages[loadingMessageIndex];
                    loadingSubtitle.style.opacity = '1';
                }, 200);
            }
        }

        function setLoadingMessage(message) {
            const loadingSubtitle = document.getElementById('loadingSubtitle');
            if (loadingSubtitle) {
                loadingSubtitle.textContent = message;
                loadingSubtitle.title = message; // Fallback for hover tooltip
                // Force a reflow to ensure the update is visible
                loadingSubtitle.offsetHeight;
                console.log('⏳ Loading message updated:', message);
            }
        }

        // Buffer Animation Functions
        function showSqlBuffer() {
            const sqlBuffer = document.getElementById('sqlEditorBuffer');
            const sqlEditor = document.getElementById('sqlEditor');
            if (sqlBuffer && sqlEditor) {
                sqlBuffer.style.display = 'block';
                sqlEditor.style.opacity = '0.3';
            }
        }

        function hideSqlBuffer() {
            const sqlBuffer = document.getElementById('sqlEditorBuffer');
            const sqlEditor = document.getElementById('sqlEditor');
            if (sqlBuffer && sqlEditor) {
                sqlBuffer.style.display = 'none';
                sqlEditor.style.opacity = '1';
            }
        }

        function showResultsBuffer() {
            const resultsBuffer = document.getElementById('resultsBuffer');
            const resultsContent = document.getElementById('resultsContent');
            if (resultsBuffer && resultsContent) {
                resultsBuffer.style.display = 'block';
                resultsContent.style.opacity = '0.3';
            }
        }

        function hideResultsBuffer() {
            const resultsBuffer = document.getElementById('resultsBuffer');
            const resultsContent = document.getElementById('resultsContent');
            if (resultsBuffer && resultsContent) {
                resultsBuffer.style.display = 'none';
                resultsContent.style.opacity = '1';
            }
        }

        function updateSqlBufferText(message) {
            const sqlBufferText = document.querySelector('.sql-buffer-text');
            if (sqlBufferText) {
                sqlBufferText.textContent = message;
            }
        }

        function updateResultsBufferText(message) {
            const resultsBufferText = document.querySelector('.results-buffer-text');
            if (resultsBufferText) {
                resultsBufferText.textContent = message;
                resultsBufferText.title = message; // Fallback for hover tooltip
                // Force a reflow to ensure the update is visible
                resultsBufferText.offsetHeight;
                console.log('🔄 Results buffer updated:', message);
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }



        // Load application configuration
        async function loadConfig() {
            try {
                const response = await fetch(API_CONFIG.configEndpoint);
                if (!response.ok) {
                    throw new Error(`Failed to load config: ${response.status}`);
                }
                appConfig = await response.json();
                console.log('✅ Configuration loaded successfully');
            } catch (error) {
                console.error('❌ Failed to load configuration:', error);
                showError('Failed to load application configuration. Please refresh the page.');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 UiASK Application Initialized');
            
            // Load configuration first
            await loadConfig();
            
            // Initialize CodeMirror SQL Editor
            initializeSqlEditor();
            
            // Set focus to natural query input
            naturalQueryInput.focus();
            
            // Add source functionality
            initializeSourceSelection();
            
            console.log('✅ SQL Editor initialized with syntax highlighting');
        });

        // Initialize source selection functionality
        function initializeSourceSelection() {
            const primarySource = document.getElementById('primarySource');
            const ontologySelect = document.getElementById('ontologySelect');
            
            primarySource.addEventListener('change', function() {
                if (this.value === 'add_source') {
                    addNewSourceDropdown();
                    // Reset the dropdown to show placeholder
                    this.value = '';
                }
            });
            
            ontologySelect.addEventListener('change', function() {
                if (this.value === 'upload_ontology') {
                    uploadOntology();
                    // Reset the dropdown to show placeholder
                    this.value = '';
                }
            });
        }

        // Add new source dropdown
        function addNewSourceDropdown() {
            const sourceSelection = document.querySelector('.source-selection');
            
            // Create wrapper for source group and remove button
            const sourceWrapper = document.createElement('div');
            sourceWrapper.className = 'additional-source-wrapper';
            
            // Create new source group
            const sourceGroup = document.createElement('div');
            sourceGroup.className = 'source-group';
            
            // Create label
            const label = document.createElement('label');
            label.textContent = 'Additional Source';
            
            // Create select element
            const select = document.createElement('select');
            select.className = 'source-select';
            
            // Add options
            const options = [
                { value: '', text: 'Select additional source...' },
                { value: 'c360', text: 'C360' },
                { value: 'datafabric', text: 'DataFabric' },
                { value: 'snowflake', text: 'Snowflake' }
            ];
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                select.appendChild(optionElement);
            });
            
            // Create remove button
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-source-btn';
            removeBtn.innerHTML = '<span>✕</span> Remove';
            
            // Add remove functionality
            removeBtn.addEventListener('click', function() {
                sourceWrapper.remove();
            });
            
            // Append elements
            sourceGroup.appendChild(label);
            sourceGroup.appendChild(select);
            sourceWrapper.appendChild(sourceGroup);
            sourceWrapper.appendChild(removeBtn);
            
            // Insert at the end of source selection
            sourceSelection.appendChild(sourceWrapper);
        }

        // Handle ontology upload
        function uploadOntology() {
            // Create a hidden file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json,.xml,.owl,.ttl';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    // Here you would typically upload the file to your server
                    console.log('Uploading ontology file:', file.name);
                    
                    // Add uploaded ontology to the select dropdown
                    const ontologySelect = document.getElementById('ontologySelect');
                    const fileName = file.name.replace(/\.[^/.]+$/, ""); // Remove file extension
                    const option = document.createElement('option');
                    option.value = fileName.toLowerCase().replace(/\s+/g, '_');
                    option.textContent = fileName;
                    
                    // Insert before the "Upload Ontology" option
                    const uploadOption = ontologySelect.querySelector('option[value="upload_ontology"]');
                    ontologySelect.insertBefore(option, uploadOption);
                    
                    // Select the newly uploaded ontology
                    ontologySelect.value = option.value;
                    
                    // Show success message
                    showNotification(`✅ Ontology "${fileName}" uploaded successfully!`, 'success');
                }
                // Clean up the file input
                document.body.removeChild(fileInput);
            });
            
            // Add to body and click to trigger file dialog
            document.body.appendChild(fileInput);
            fileInput.click();
        }

        // Show notification
        function showNotification(message, type = 'info', duration = 3000) {
            // Remove any existing polling notifications to avoid spam
            if (message.includes('Polling for results')) {
                const existingPollingNotifications = document.querySelectorAll('.polling-notification');
                existingPollingNotifications.forEach(notif => {
                    if (notif.parentNode) {
                        notif.parentNode.removeChild(notif);
                    }
                });
            }

            const notification = document.createElement('div');
            notification.className = message.includes('Polling for results') ? 'polling-notification' : '';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 9999;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                backdrop-filter: blur(10px);
                transition: all 0.3s ease;
                transform: translateX(100%);
                opacity: 0;
            `;
            
            if (type === 'success') {
                notification.style.background = 'rgba(34, 197, 94, 0.9)';
                notification.style.border = '1px solid rgba(34, 197, 94, 0.5)';
            } else if (type === 'warning') {
                notification.style.background = 'rgba(245, 158, 11, 0.9)';
                notification.style.border = '1px solid rgba(245, 158, 11, 0.5)';
            } else {
                notification.style.background = 'rgba(59, 130, 246, 0.9)';
                notification.style.border = '1px solid rgba(59, 130, 246, 0.5)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
            }, 100);
            
            // Remove after specified duration (shorter for polling notifications)
            const notificationDuration = message.includes('Polling for results') ? 1500 : duration;
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, notificationDuration);
        }
    </script>
</body>
</html> 